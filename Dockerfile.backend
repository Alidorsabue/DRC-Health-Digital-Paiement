# Dockerfile Ã  la racine pour Railway
# Ce fichier construit le backend depuis la racine du projet
FROM node:18-alpine AS builder

# Installer les dÃ©pendances systÃ¨me nÃ©cessaires
RUN apk add --no-cache python3 make g++

WORKDIR /app

# Copier les fichiers de configuration du backend
COPY backend/package*.json ./
COPY backend/tsconfig.json ./
COPY backend/nest-cli.json* ./

# Installer les dÃ©pendances
# Utiliser npm install (plus flexible que npm ci qui nÃ©cessite package-lock.json)
RUN npm install --production=false

# Copier le code source du backend
COPY backend/src ./src
# Copier les migrations (nÃ©cessaires pour migration:run)
COPY backend/migrations ./migrations
# Copier les scripts (nÃ©cessaires pour run-sql-migrations.js)
COPY backend/scripts ./scripts

# Builder l'application
RUN npm run build

# Image de production
FROM node:18-alpine

WORKDIR /app

# Copier les fichiers nÃ©cessaires depuis le builder
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
# Copier les fichiers de migration et de configuration nÃ©cessaires
COPY --from=builder /app/tsconfig.json ./
COPY --from=builder /app/src ./src
COPY --from=builder /app/migrations ./migrations
COPY --from=builder /app/scripts ./scripts

# Exposer le port (Railway utilisera la variable PORT)
EXPOSE 3001

# CrÃ©er un script de dÃ©marrage qui exÃ©cute les migrations puis dÃ©marre l'application
RUN echo '#!/bin/sh' > start.sh && \
    echo 'set -e' >> start.sh && \
    echo 'echo ""' >> start.sh && \
    echo 'echo "========================================="' >> start.sh && \
    echo 'echo "ğŸš€ DÃ‰MARRAGE DU CONTENEUR"' >> start.sh && \
    echo 'echo "========================================="' >> start.sh && \
    echo 'echo ""' >> start.sh && \
    echo 'echo "ğŸ“‚ VÃ©rification des fichiers..."' >> start.sh && \
    echo 'ls -la /app/scripts/ || echo "âš ï¸  Dossier scripts non trouvÃ©"' >> start.sh && \
    echo 'ls -la /app/dist/ || echo "âš ï¸  Dossier dist non trouvÃ©"' >> start.sh && \
    echo 'echo ""' >> start.sh && \
    echo 'echo "========================================="' >> start.sh && \
    echo 'echo "ğŸ”„ EXÃ‰CUTION DES MIGRATIONS"' >> start.sh && \
    echo 'echo "========================================="' >> start.sh && \
    echo 'echo ""' >> start.sh && \
    echo 'node scripts/run-sql-migrations.js' >> start.sh && \
    echo 'MIGRATION_EXIT_CODE=$?' >> start.sh && \
    echo 'if [ $MIGRATION_EXIT_CODE -ne 0 ]; then' >> start.sh && \
    echo '  echo ""' >> start.sh && \
    echo '  echo "âŒ ERREUR: Les migrations ont Ã©chouÃ© avec le code $MIGRATION_EXIT_CODE!"' >> start.sh && \
    echo '  exit 1' >> start.sh && \
    echo 'fi' >> start.sh && \
    echo 'echo ""' >> start.sh && \
    echo 'echo "========================================="' >> start.sh && \
    echo 'echo "ğŸš€ DÃ‰MARRAGE DE L'\''APPLICATION"' >> start.sh && \
    echo 'echo "========================================="' >> start.sh && \
    echo 'echo ""' >> start.sh && \
    echo 'node dist/main.js' >> start.sh && \
    chmod +x start.sh

# Utiliser le script au dÃ©marrage
CMD ["sh", "start.sh"]

